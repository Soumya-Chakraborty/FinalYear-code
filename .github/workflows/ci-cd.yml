name: CI/CD Pipeline

permissions:
  contents: write
  packages: write
  actions: write

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: [3.8, 3.9, '3.10', '3.11', '3.12']

    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libsndfile1-dev ffmpeg portaudio19-dev
    
    - name: Cache pip dependencies
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Lint with flake8
      run: |
        pip install flake8
        # Stop the build if there are Python syntax errors or undefined names
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        # Exit-zero treats all errors as warnings
        flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
    
    - name: Test with pytest
      run: |
        python -c "import main; print('Import successful')"
        python -c "import module_1_ear; import module_2_translator; import module_3_judge; print('All modules imported successfully')"
        python test_imports.py
    
    - name: Run basic functionality test
      run: |
        # Create a minimal test to verify the system works
        python -c "
        import sys
        import os
        sys.path.insert(0, os.getcwd())
        
        # Test importing main components
        import main
        import module_1_ear
        import module_2_translator
        import module_3_judge
        print('✓ All modules imported successfully')
        
        # Test basic functionality
        import numpy as np
        import librosa
        import torch
        print(f'✓ NumPy version: {np.__version__}')
        print(f'✓ Librosa version: {librosa.__version__}')
        print(f'✓ PyTorch version: {torch.__version__}')
        print('✓ Basic functionality test passed')
        "

  security_scan:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Security scan with Bandit
      run: |
        pip install bandit
        bandit -r . -x .git,__pycache__,venv || echo "Security scan completed with warnings"
    
  deploy:
    needs: [test, security_scan]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libsndfile1-dev ffmpeg portaudio19-dev
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Verify repository files before build
      run: |
        echo "Listing repo root:"
        ls -la
        echo "Show requirements.txt existence and head:"
        if [ -f "requirements.txt" ]; then
          echo "requirements.txt found"
          head -n 20 requirements.txt || true
        else
          echo "ERROR: requirements.txt not found in repository root"
          exit 1
        fi

    - name: Check release token and decide
      id: token_check
      run: |
        if [ -n "${{ secrets.RELEASE_PAT }}" ]; then
          echo "token_source=RELEASE_PAT" >> $GITHUB_OUTPUT
          echo "Using RELEASE_PAT for release operations"
          exit 0
        fi
        if [ -n "${{ secrets.GITHUB_TOKEN }}" ]; then
          echo "token_source=GITHUB_TOKEN" >> $GITHUB_OUTPUT
          echo "Using GITHUB_TOKEN for release operations"
          exit 0
        fi
        echo "No release token available; skipping release and artifact upload"
        echo "token_source=none" >> $GITHUB_OUTPUT

    - name: Deploy to PyPI (dry run)
      if: steps.token_check.outputs.token_source != 'none'
      run: |
        pip install build twine
        python -m build
        # Only do dry run in this example - would upload to PyPI in real deployment
        # twine upload --repository testpypi dist/*
        echo "Package built successfully"

    - name: Create Release
      if: steps.token_check.outputs.token_source != 'none'
      uses: actions/create-release@v1
      with:
        token: ${{ secrets.RELEASE_PAT != '' && secrets.RELEASE_PAT || secrets.GITHUB_TOKEN }}
        tag_name: v${{ github.run_number }}
        release_name: Release v${{ github.run_number }}
        draft: false
        prerelease: false

  code_quality:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Check for large files
      run: |
        find . -size +50M -not -path "./.git/*" -exec ls -lh {} \;
    
    - name: Verify documentation
      run: |
        if [ ! -f "README.md" ]; then
          echo "ERROR: README.md not found!"
          exit 1
        fi
        if [ ! -f "LICENSE" ]; then
          echo "ERROR: LICENSE not found!"
          exit 1
        fi
        echo "✓ Documentation files verified"
    
    - name: Check code formatting
      run: |
        pip install black
        # Check if code is formatted with black (without making changes)
        python -m black --check --diff . || echo "Note: Some files may need formatting with black"